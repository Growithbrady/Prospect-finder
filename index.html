<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prospect Finder — Local Business Intelligence Tool</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=JetBrains+Mono:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0e14;
            --surface: #151920;
            --border: #2d3340;
            --accent: #00ff88;
            --accent-dim: #00ff8833;
            --danger: #ff0055;
            --warning: #ffaa00;
            --text: #e6edf3;
            --text-dim: #8b949e;
            --font-mono: 'JetBrains Mono', monospace;
            --font-display: 'Space Mono', monospace;
        }

        body {
            font-family: var(--font-mono);
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(0, 255, 136, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 136, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            margin-bottom: 60px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 30px;
        }

        h1 {
            font-family: var(--font-display);
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: -2px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent) 0%, #00ccff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-dim);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), transparent);
        }

        .panel-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--accent);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 8px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: var(--font-mono);
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }

        input::placeholder {
            color: var(--text-dim);
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        button {
            background: var(--accent);
            color: var(--bg);
            border: none;
            padding: 16px 32px;
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            background: #00dd77;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: var(--border);
            color: var(--text-dim);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
        }

        .btn-secondary:hover {
            background: var(--accent-dim);
        }

        #status {
            margin-top: 30px;
            padding: 20px;
            background: var(--bg);
            border-left: 4px solid var(--accent);
            font-size: 0.9rem;
            display: none;
        }

        #status.error {
            border-left-color: var(--danger);
        }

        #status.warning {
            border-left-color: var(--warning);
        }

        .status-line {
            margin: 5px 0;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        #results {
            margin-top: 40px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-display);
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-top: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
            font-size: 0.85rem;
        }

        thead {
            background: var(--bg);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: var(--bg);
        }

        .score {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .score.hot { color: #00ff88; }
        .score.warm { color: #ffaa00; }
        .score.cold { color: #ff0055; }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .badge.no-website {
            background: var(--danger);
            color: white;
        }

        .badge.has-website {
            background: var(--border);
            color: var(--text-dim);
        }

        .help-text {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 5px;
            font-style: italic;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #progress {
            height: 4px;
            background: var(--border);
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        #progress-bar {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PROSPECT FINDER</h1>
            <div class="subtitle">Local Business Intelligence Tool</div>
        </header>

        <div class="grid">
            <div class="panel">
                <div class="panel-title">Search Parameters</div>
                
                <div class="form-group">
                    <label>Google API Key</label>
                    <input type="password" id="apiKey" placeholder="AIzaSy...">
                    <div class="help-text">Get yours free at console.cloud.google.com</div>
                </div>

                <div class="form-group">
                    <label>City & State</label>
                    <input type="text" id="location" value="Columbus, Ohio" placeholder="e.g., Austin, Texas">
                </div>

                <div class="form-group">
                    <label>Business Type</label>
                    <select id="businessType">
                        <option value="HVAC">HVAC / Heating & Cooling</option>
                        <option value="plumbing">Plumbing</option>
                        <option value="roofing">Roofing</option>
                        <option value="electrical">Electrical</option>
                        <option value="landscaping">Landscaping</option>
                        <option value="pest control">Pest Control</option>
                        <option value="cleaning services">Cleaning Services</option>
                        <option value="handyman">Handyman Services</option>
                        <option value="custom">Custom (specify below)</option>
                    </select>
                </div>

                <div class="form-group" id="customTypeGroup" style="display:none;">
                    <label>Custom Business Type</label>
                    <input type="text" id="customType" placeholder="e.g., auto repair">
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">Filter Settings</div>
                
                <div class="input-group">
                    <div class="form-group">
                        <label>Max Rating</label>
                        <input type="number" id="maxRating" value="3.8" step="0.1" min="1" max="5">
                        <div class="help-text">3.8 or below</div>
                    </div>

                    <div class="form-group">
                        <label>Min Reviews</label>
                        <input type="number" id="minReviews" value="3" min="0">
                        <div class="help-text">Proves legitimacy</div>
                    </div>
                </div>

                <div class="input-group">
                    <div class="form-group">
                        <label>Max Reviews</label>
                        <input type="number" id="maxReviews" value="150" min="0">
                        <div class="help-text">Avoid big players</div>
                    </div>

                    <div class="form-group">
                        <label>Max Results</label>
                        <input type="number" id="maxResults" value="50" min="1" max="200">
                        <div class="help-text">API cost control</div>
                    </div>
                </div>

                <button id="runScraper" style="width: 100%; margin-top: 20px;">
                    Run Search
                </button>
            </div>
        </div>

        <div id="progress">
            <div id="progress-bar"></div>
        </div>

        <div id="status"></div>

        <div id="results" style="display: none;">
            <div class="results-header">
                <h2>Results</h2>
                <div class="action-buttons">
                    <button class="btn-secondary" id="downloadCsv">Download CSV</button>
                    <button class="btn-secondary" id="copyAll">Copy All</button>
                </div>
            </div>

            <div class="stats" id="statsContainer"></div>

            <div class="panel">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>Score</th>
                            <th>Business Name</th>
                            <th>Phone</th>
                            <th>Rating</th>
                            <th>Reviews</th>
                            <th>Website</th>
                            <th>Address</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allProspects = [];

        // Show/hide custom business type input
        document.getElementById('businessType').addEventListener('change', (e) => {
            const customGroup = document.getElementById('customTypeGroup');
            customGroup.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });

        // Main scraper function
        document.getElementById('runScraper').addEventListener('click', async () => {
            const apiKey = document.getElementById('apiKey').value.trim();
            const location = document.getElementById('location').value.trim();
            const businessTypeSelect = document.getElementById('businessType').value;
            const businessType = businessTypeSelect === 'custom' 
                ? document.getElementById('customType').value.trim()
                : businessTypeSelect;
            
            const maxRating = parseFloat(document.getElementById('maxRating').value);
            const minReviews = parseInt(document.getElementById('minReviews').value);
            const maxReviews = parseInt(document.getElementById('maxReviews').value);
            const maxResults = parseInt(document.getElementById('maxResults').value);

            // Validation
            if (!apiKey) {
                showStatus('Please enter your Google API key', 'error');
                return;
            }
            if (!location) {
                showStatus('Please enter a city and state', 'error');
                return;
            }
            if (!businessType) {
                showStatus('Please enter a business type', 'error');
                return;
            }

            // Reset
            allProspects = [];
            document.getElementById('results').style.display = 'none';
            document.getElementById('progress').style.display = 'block';
            setProgress(0);

            showStatus('Starting search...', 'info');
            disableButton(true);

            try {
                // Test API key first
                const testResult = await testApiKey(apiKey);
                if (!testResult.success) {
                    showStatus(`API Error: ${testResult.error}`, 'error');
                    disableButton(false);
                    return;
                }

                addStatusLine('✓ API key validated');
                setProgress(10);

                // Generate search queries
                const queries = generateQueries(businessType, location);
                addStatusLine(`Generated ${queries.length} search variations`);
                setProgress(20);

                // Search for businesses
                let allPlaces = [];
                for (let i = 0; i < queries.length; i++) {
                    addStatusLine(`Searching: ${queries[i]}`);
                    const results = await searchPlaces(queries[i], apiKey);
                    allPlaces = allPlaces.concat(results);
                    setProgress(20 + (30 * (i + 1) / queries.length));
                    await sleep(500); // Be nice to the API
                }

                // Deduplicate by place_id
                const uniquePlaces = {};
                allPlaces.forEach(place => {
                    const id = place.place_id;
                    if (!uniquePlaces[id]) {
                        uniquePlaces[id] = place;
                    }
                });

                addStatusLine(`Found ${Object.keys(uniquePlaces).length} unique businesses`);
                setProgress(50);

                // Filter by rating and reviews
                const filtered = Object.values(uniquePlaces).filter(place => {
                    const rating = place.rating || 0;
                    const reviews = place.user_ratings_total || 0;
                    return rating <= maxRating && 
                           reviews >= minReviews && 
                           reviews <= maxReviews;
                });

                addStatusLine(`${filtered.length} businesses match your filters`);
                setProgress(60);

                // Fetch details for each (limited by maxResults)
                const toFetch = filtered.slice(0, maxResults);
                addStatusLine(`Fetching details for top ${toFetch.length} prospects...`);

                for (let i = 0; i < toFetch.length; i++) {
                    const place = toFetch[i];
                    addStatusLine(`[${i + 1}/${toFetch.length}] ${place.name}`);
                    
                    const details = await getPlaceDetails(place.place_id, apiKey);
                    const score = scoreOpportunity(details);
                    
                    allProspects.push({
                        score: score.score,
                        name: details.name || place.name,
                        phone: details.formatted_phone_number || 'N/A',
                        address: details.formatted_address || place.formatted_address || 'N/A',
                        rating: details.rating || place.rating || 'N/A',
                        reviews: details.user_ratings_total || place.user_ratings_total || 0,
                        website: details.website || '',
                        mapsUrl: details.url || '',
                        reasons: score.reasons
                    });

                    setProgress(60 + (35 * (i + 1) / toFetch.length));
                    await sleep(300);
                }

                // Sort by score
                allProspects.sort((a, b) => b.score - a.score);

                setProgress(100);
                addStatusLine(`✓ Complete! Found ${allProspects.length} prospects`);
                
                displayResults();
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error(error);
            } finally {
                disableButton(false);
                setTimeout(() => {
                    document.getElementById('progress').style.display = 'none';
                }, 1000);
            }
        });

        // API Functions
        async function testApiKey(apiKey) {
            try {
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=test&key=${apiKey}`;
                const url = proxyUrl + encodeURIComponent(apiUrl);
                const resp = await fetch(url);
                const data = await resp.json();
                
                if (data.status === 'REQUEST_DENIED') {
                    return { success: false, error: data.error_message || 'API key denied. Enable Places API and billing.' };
                }
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function searchPlaces(query, apiKey) {
            // Using CORS proxy to bypass browser restrictions
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query)}&key=${apiKey}`;
            const url = proxyUrl + encodeURIComponent(apiUrl);
            const resp = await fetch(url);
            const data = await resp.json();
            
            if (data.status === 'OK') {
                return data.results || [];
            }
            return [];
        }

        async function getPlaceDetails(placeId, apiKey) {
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const fields = 'name,formatted_address,formatted_phone_number,website,rating,user_ratings_total,business_status,url';
            const apiUrl = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=${fields}&key=${apiKey}`;
            const url = proxyUrl + encodeURIComponent(apiUrl);
            const resp = await fetch(url);
            const data = await resp.json();
            return data.result || {};
        }

        // Scoring
        function scoreOpportunity(details) {
            let score = 0;
            let reasons = [];

            const rating = details.rating || 5;
            const reviews = details.user_ratings_total || 0;
            const hasWebsite = !!details.website;

            if (rating <= 2.5) {
                score += 35;
                reasons.push('Very low rating');
            } else if (rating <= 3.0) {
                score += 30;
                reasons.push('Low rating');
            } else if (rating <= 3.5) {
                score += 22;
                reasons.push('Below average rating');
            } else if (rating <= 3.8) {
                score += 12;
                reasons.push('Slightly below average');
            }

            if (!hasWebsite) {
                score += 30;
                reasons.push('NO WEBSITE');
            }

            if (reviews >= 5 && reviews <= 30) {
                score += 20;
                reasons.push('Small review count');
            } else if (reviews > 30 && reviews <= 80) {
                score += 15;
                reasons.push('Moderate reviews');
            } else if (reviews > 80) {
                score += 5;
            } else {
                score += 8;
            }

            if (details.formatted_phone_number) score += 5;
            if (details.business_status === 'OPERATIONAL') score += 10;

            return { score, reasons: reasons.join(' | ') };
        }

        // Query generation
        function generateQueries(businessType, location) {
            const variations = [
                `${businessType} ${location}`,
                `${businessType} contractor ${location}`,
                `${businessType} repair ${location}`,
                `${businessType} service ${location}`,
                `${businessType} company ${location}`
            ];
            return variations;
        }

        // Display results
        function displayResults() {
            const hot = allProspects.filter(p => p.score >= 70).length;
            const warm = allProspects.filter(p => p.score >= 50 && p.score < 70).length;
            const cold = allProspects.filter(p => p.score < 50).length;
            const noWebsite = allProspects.filter(p => !p.website).length;

            // Stats
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-value">${allProspects.length}</div>
                    <div class="stat-label">Total Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${hot}</div>
                    <div class="stat-label">Hot Leads</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${warm}</div>
                    <div class="stat-label">Warm Leads</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${noWebsite}</div>
                    <div class="stat-label">No Website</div>
                </div>
            `;
            document.getElementById('statsContainer').innerHTML = statsHtml;

            // Table
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            allProspects.forEach(p => {
                const scoreClass = p.score >= 70 ? 'hot' : p.score >= 50 ? 'warm' : 'cold';
                const websiteBadge = p.website 
                    ? '<span class="badge has-website">Yes</span>'
                    : '<span class="badge no-website">NO</span>';

                const row = `
                    <tr>
                        <td><span class="score ${scoreClass}">${p.score}</span></td>
                        <td><strong>${p.name}</strong><br><small style="color: var(--text-dim)">${p.reasons}</small></td>
                        <td>${p.phone}</td>
                        <td>${p.rating} ⭐</td>
                        <td>${p.reviews}</td>
                        <td>${websiteBadge}</td>
                        <td><small>${p.address}</small></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            document.getElementById('results').style.display = 'block';
        }

        // Export functions
        document.getElementById('downloadCsv').addEventListener('click', () => {
            const csv = convertToCSV(allProspects);
            downloadFile(csv, 'prospects.csv', 'text/csv');
        });

        document.getElementById('copyAll').addEventListener('click', () => {
            const csv = convertToCSV(allProspects);
            navigator.clipboard.writeText(csv);
            alert('Copied to clipboard!');
        });

        function convertToCSV(data) {
            const headers = ['Score', 'Business Name', 'Phone', 'Rating', 'Reviews', 'Website', 'Address', 'Google Maps URL', 'Why Opportunity'];
            const rows = data.map(p => [
                p.score,
                p.name,
                p.phone,
                p.rating,
                p.reviews,
                p.website || 'NO',
                p.address,
                p.mapsUrl,
                p.reasons
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            return csvContent;
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // UI Helpers
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="status-line">${message}</div>`;
            status.className = type;
            status.style.display = 'block';
        }

        function addStatusLine(message) {
            const status = document.getElementById('status');
            const line = document.createElement('div');
            line.className = 'status-line';
            line.textContent = message;
            status.appendChild(line);
            status.scrollTop = status.scrollHeight;
        }

        function setProgress(percent) {
            document.getElementById('progress-bar').style.width = percent + '%';
        }

        function disableButton(disabled) {
            const btn = document.getElementById('runScraper');
            btn.disabled = disabled;
            btn.innerHTML = disabled ? 'Running Search...<span class="loading"></span>' : 'Run Search';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
