<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prospect Finder ‚Äî Local Business Intelligence Tool</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=JetBrains+Mono:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0e14;
            --surface: #151920;
            --border: #2d3340;
            --accent: #00ff88;
            --accent-dim: #00ff8833;
            --accent2: #00ccff;
            --danger: #ff0055;
            --warning: #ffaa00;
            --text: #e6edf3;
            --text-dim: #8b949e;
            --font-mono: 'JetBrains Mono', monospace;
            --font-display: 'Space Mono', monospace;
        }

        body {
            font-family: var(--font-mono);
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(0, 255, 136, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 136, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            margin-bottom: 60px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 30px;
        }

        h1 {
            font-family: var(--font-display);
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: -2px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent) 0%, #00ccff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-dim);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1100px) {
            .grid-3 { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 900px) {
            .grid, .grid-3 { grid-template-columns: 1fr; }
        }

        .panel {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), transparent);
        }

        .panel-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--accent);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 8px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: var(--font-mono);
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }

        input::placeholder {
            color: var(--text-dim);
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-item:hover {
            border-color: var(--accent);
        }

        .toggle-item.active {
            border-color: var(--accent);
            background: var(--accent-dim);
        }

        .toggle-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .toggle-item.active .toggle-label {
            color: var(--accent);
        }

        .toggle-switch {
            width: 40px;
            height: 20px;
            background: var(--border);
            border-radius: 10px;
            position: relative;
            transition: all 0.2s;
        }

        .toggle-item.active .toggle-switch {
            background: var(--accent);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all 0.2s;
        }

        .toggle-item.active .toggle-switch::after {
            left: 23px;
        }

        /* Website Filter Tabs */
        .tab-group {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: var(--bg);
            border: none;
            color: var(--text-dim);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            border-right: 1px solid var(--border);
        }

        .tab-btn:last-child { border-right: none; }

        .tab-btn:hover {
            background: var(--surface);
            color: var(--text);
        }

        .tab-btn.active {
            background: var(--accent-dim);
            color: var(--accent);
            border-color: var(--accent);
        }

        button {
            background: var(--accent);
            color: var(--bg);
            border: none;
            padding: 16px 32px;
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            background: #00dd77;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        button:active { transform: translateY(0); }

        button:disabled {
            background: var(--border);
            color: var(--text-dim);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
        }

        .btn-secondary:hover { background: var(--accent-dim); }

        #status {
            margin-top: 30px;
            padding: 20px;
            background: var(--bg);
            border-left: 4px solid var(--accent);
            font-size: 0.9rem;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        #status.error { border-left-color: var(--danger); }
        #status.warning { border-left-color: var(--warning); }

        .status-line {
            margin: 5px 0;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn { to { opacity: 1; } }

        #results { margin-top: 40px; }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-display);
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-top: 5px;
        }

        /* Result Tabs */
        .result-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            width: fit-content;
        }

        .result-tab {
            padding: 12px 24px;
            background: var(--bg);
            border: none;
            color: var(--text-dim);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            border-right: 1px solid var(--border);
        }

        .result-tab:last-child { border-right: none; }
        .result-tab:hover { background: var(--surface); color: var(--text); }
        .result-tab.active { background: var(--accent-dim); color: var(--accent); }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
            font-size: 0.85rem;
        }

        thead { background: var(--bg); }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover { background: var(--bg); }

        .score {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .score.hot { color: #00ff88; }
        .score.warm { color: #ffaa00; }
        .score.cold { color: #ff0055; }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .badge.no-website { background: var(--danger); color: white; }
        .badge.has-website { background: #1a3a2a; color: var(--accent); border: 1px solid var(--accent); }

        .help-text {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 5px;
            font-style: italic;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        #progress {
            height: 4px;
            background: var(--border);
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        #progress-bar {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .website-link {
            color: var(--accent2);
            text-decoration: none;
            font-size: 0.8rem;
        }

        .website-link:hover { text-decoration: underline; }

        .info-box {
            background: var(--accent-dim);
            border: 1px solid var(--accent);
            padding: 12px 16px;
            font-size: 0.8rem;
            color: var(--accent);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PROSPECT FINDER</h1>
            <div class="subtitle">Local Business Intelligence Tool</div>
        </header>

        <div class="grid">
            <!-- LEFT: Search Parameters -->
            <div class="panel">
                <div class="panel-title">Search Parameters</div>
                
                <div class="form-group">
                    <label>Google API Key</label>
                    <input type="password" id="apiKey" placeholder="AIzaSy...">
                    <div class="help-text">Get yours free at console.cloud.google.com</div>
                </div>

                <div class="form-group">
                    <label>City & State</label>
                    <input type="text" id="location" value="Columbus, Ohio" placeholder="e.g., Austin, Texas">
                    <div class="help-text">Works for any city worldwide</div>
                </div>

                <div class="form-group">
                    <label>Business Type</label>
                    <select id="businessType">
                        <option value="HVAC">HVAC / Heating & Cooling</option>
                        <option value="plumbing">Plumbing</option>
                        <option value="roofing">Roofing</option>
                        <option value="electrical">Electrical</option>
                        <option value="landscaping">Landscaping</option>
                        <option value="pest control">Pest Control</option>
                        <option value="cleaning services">Cleaning Services</option>
                        <option value="handyman">Handyman Services</option>
                        <option value="custom">Custom (specify below)</option>
                    </select>
                </div>

                <div class="form-group" id="customTypeGroup" style="display:none;">
                    <label>Custom Business Type</label>
                    <input type="text" id="customType" placeholder="e.g., auto repair">
                </div>

                <div class="form-group">
                    <label>Max Results</label>
                    <input type="number" id="maxResults" value="50" min="1" max="200">
                    <div class="help-text">API cost control (higher = more API calls)</div>
                </div>
            </div>

            <!-- RIGHT: Filter Settings -->
            <div class="panel">
                <div class="panel-title">Filter Settings</div>

                <div class="input-group">
                    <div class="form-group">
                        <label>Min Rating</label>
                        <input type="number" id="minRating" value="1.0" step="0.1" min="1" max="5">
                        <div class="help-text">Exclude ghost listings</div>
                    </div>
                    <div class="form-group">
                        <label>Max Rating</label>
                        <input type="number" id="maxRating" value="4.4" step="0.1" min="1" max="5">
                        <div class="help-text">4.4 catches most SMBs</div>
                    </div>
                </div>

                <div class="input-group">
                    <div class="form-group">
                        <label>Min Reviews</label>
                        <input type="number" id="minReviews" value="3" min="0">
                        <div class="help-text">Proves legitimacy</div>
                    </div>
                    <div class="form-group">
                        <label>Max Reviews</label>
                        <input type="number" id="maxReviews" value="500" min="0">
                        <div class="help-text">Avoid big players</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Website Filter</label>
                    <div class="tab-group">
                        <button class="tab-btn active" data-filter="all">All Businesses</button>
                        <button class="tab-btn" data-filter="no-website">No Website Only</button>
                        <button class="tab-btn" data-filter="has-website">Has Website Only</button>
                    </div>
                    <div class="help-text" id="websiteFilterHelp">Showing all businesses regardless of website status</div>
                </div>

                <div class="form-group">
                    <label>Keywords to Include (optional)</label>
                    <input type="text" id="includeKeywords" placeholder="e.g., move out, deep clean, residential">
                    <div class="help-text">Comma separated ‚Äî only show businesses matching these terms</div>
                </div>

                <div class="form-group">
                    <label>Keywords to Exclude (optional)</label>
                    <input type="text" id="excludeKeywords" placeholder="e.g., LLC, national, franchise">
                    <div class="help-text">Comma separated ‚Äî filters out big chains</div>
                </div>

                <button id="runScraper" style="width: 100%; margin-top: 10px;">
                    Run Search
                </button>
            </div>
        </div>

        <div id="progress">
            <div id="progress-bar"></div>
        </div>

        <div id="status"></div>

        <div id="results" style="display: none;">
            <div class="results-header">
                <h2>Results</h2>
                <div class="action-buttons">
                    <button class="btn-secondary" id="downloadCsv">Download CSV</button>
                    <button class="btn-secondary" id="copyAll">Copy All</button>
                </div>
            </div>

            <div class="stats" id="statsContainer"></div>

            <!-- Result view tabs -->
            <div class="result-tabs">
                <button class="result-tab active" data-view="all">All</button>
                <button class="result-tab" data-view="no-website">No Website</button>
                <button class="result-tab" data-view="has-website">Has Website</button>
                <button class="result-tab" data-view="hot">Hot Leads</button>
            </div>

            <div class="panel">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>Score</th>
                            <th>Business Name</th>
                            <th>Phone</th>
                            <th>Rating</th>
                            <th>Reviews</th>
                            <th>Website</th>
                            <th>Address</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // FILE VERSION CHECK
        // ========================================
        console.log('%c‚úÖ CORRECT FILE LOADED', 'color: #00ff88; font-size: 16px; font-weight: bold');
        console.log('%c‚úÖ Using Vercel Backend (NOT allorigins)', 'color: #00ff88; font-size: 14px');
        console.log('%c‚úÖ Backend URL: https://prospect-finder-api.vercel.app/api', 'color: #00ccff; font-size: 12px');
        
        // ========================================
        // BACKEND API CONFIGURATION
        // ========================================
        const BACKEND_API_URL = 'https://prospect-finder-api.vercel.app/api';
        
        let allProspects = [];
        let websiteFilter = 'all';
        let currentView = 'all';

        // ========================================
        // UI EVENT LISTENERS
        // ========================================

        // Custom business type toggle
        document.getElementById('businessType').addEventListener('change', (e) => {
            const customGroup = document.getElementById('customTypeGroup');
            customGroup.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });

        // Website filter tabs (search filter)
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                websiteFilter = btn.dataset.filter;
                const helpMap = {
                    'all': 'Showing all businesses regardless of website status',
                    'no-website': 'üéØ Only businesses with NO website ‚Äî highest opportunity',
                    'has-website': 'üîß Only businesses with a website ‚Äî potential redesign clients'
                };
                document.getElementById('websiteFilterHelp').textContent = helpMap[websiteFilter];
            });
        });

        // Result view tabs
        document.querySelectorAll('.result-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.result-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentView = btn.dataset.view;
                renderTable();
            });
        });

        // ========================================
        // MAIN SEARCH FUNCTION
        // ========================================
        document.getElementById('runScraper').addEventListener('click', async () => {
            const apiKey = document.getElementById('apiKey').value.trim();
            const location = document.getElementById('location').value.trim();
            const businessTypeSelect = document.getElementById('businessType').value;
            const businessType = businessTypeSelect === 'custom' 
                ? document.getElementById('customType').value.trim()
                : businessTypeSelect;
            
            const minRating = parseFloat(document.getElementById('minRating').value);
            const maxRating = parseFloat(document.getElementById('maxRating').value);
            const minReviews = parseInt(document.getElementById('minReviews').value);
            const maxReviews = parseInt(document.getElementById('maxReviews').value);
            const maxResults = parseInt(document.getElementById('maxResults').value);
            const excludeKeywords = document.getElementById('excludeKeywords').value
                .split(',').map(k => k.trim().toLowerCase()).filter(k => k.length > 0);
            const includeKeywords = document.getElementById('includeKeywords').value
                .split(',').map(k => k.trim().toLowerCase()).filter(k => k.length > 0);

            if (!apiKey) { showStatus('Please enter your Google API key', 'error'); return; }
            if (!location) { showStatus('Please enter a city and state', 'error'); return; }
            if (!businessType) { showStatus('Please enter a business type', 'error'); return; }

            allProspects = [];
            document.getElementById('results').style.display = 'none';
            document.getElementById('progress').style.display = 'block';
            setProgress(0);
            showStatus('Starting search...', 'info');
            disableButton(true);

            try {
                const testResult = await testApiKey(apiKey);
                if (!testResult.success) {
                    showStatus(`API Error: ${testResult.error}`, 'error');
                    disableButton(false);
                    return;
                }

                addStatusLine('‚úì API key validated');
                setProgress(10);

                const queries = generateQueries(businessType, location);
                addStatusLine(`Generated ${queries.length} search variations`);
                setProgress(15);

                let allPlaces = [];
                for (let i = 0; i < queries.length; i++) {
                    addStatusLine(`Searching: ${queries[i]}`);
                    const results = await searchPlaces(queries[i], apiKey);
                    allPlaces = allPlaces.concat(results);
                    setProgress(15 + (30 * (i + 1) / queries.length));
                    await sleep(400);
                }

                // Deduplicate
                const uniquePlaces = {};
                allPlaces.forEach(place => {
                    if (!uniquePlaces[place.place_id]) {
                        uniquePlaces[place.place_id] = place;
                    }
                });

                addStatusLine(`Found ${Object.keys(uniquePlaces).length} unique businesses`);
                setProgress(50);

                // Filter
                let filtered = Object.values(uniquePlaces).filter(place => {
                    const rating = place.rating || 0;
                    const reviews = place.user_ratings_total || 0;
                    const name = (place.name || '').toLowerCase();

                    // Rating & review filters
                    if (rating < minRating || rating > maxRating) return false;
                    if (reviews < minReviews || reviews > maxReviews) return false;

                    // Exclude keywords
                    if (excludeKeywords.length > 0) {
                        if (excludeKeywords.some(kw => name.includes(kw))) return false;
                    }

                    // Include keywords ‚Äî checked against name, types, and reviews after details fetch
                    // (pre-filter by name only at this stage, full check happens after details)

                    return true;
                });

                addStatusLine(`${filtered.length} businesses match your filters`);
                setProgress(60);

                const toFetch = filtered.slice(0, maxResults);
                addStatusLine(`Fetching details for top ${toFetch.length} prospects...`);

                for (let i = 0; i < toFetch.length; i++) {
                    const place = toFetch[i];
                    addStatusLine(`[${i + 1}/${toFetch.length}] ${place.name}`);
                    
                    const details = await getPlaceDetails(place.place_id, apiKey);
                    const hasWebsite = !!details.website;

                    // Apply include keywords filter ‚Äî check types array and review text
                    if (includeKeywords.length > 0) {
                        const typesText = (details.types || []).join(' ').toLowerCase();
                        const reviewsText = (details.reviews || [])
                            .map(r => (r.text || '').toLowerCase())
                            .join(' ');
                        const searchText = typesText + ' ' + reviewsText;
                        if (!includeKeywords.some(kw => searchText.includes(kw))) {
                            setProgress(60 + (35 * (i + 1) / toFetch.length));
                            await sleep(200);
                            continue;
                        }
                    }

                    // Apply website filter
                    if (websiteFilter === 'no-website' && hasWebsite) {
                        setProgress(60 + (35 * (i + 1) / toFetch.length));
                        await sleep(200);
                        continue;
                    }
                    if (websiteFilter === 'has-website' && !hasWebsite) {
                        setProgress(60 + (35 * (i + 1) / toFetch.length));
                        await sleep(200);
                        continue;
                    }

                    const score = scoreOpportunity(details);
                    
                    allProspects.push({
                        score: score.score,
                        name: details.name || place.name,
                        phone: details.formatted_phone_number || 'N/A',
                        address: details.formatted_address || place.formatted_address || 'N/A',
                        rating: details.rating || place.rating || 'N/A',
                        reviews: details.user_ratings_total || place.user_ratings_total || 0,
                        website: details.website || '',
                        mapsUrl: details.url || '',
                        reasons: score.reasons,
                        opportunity: score.opportunity
                    });

                    setProgress(60 + (35 * (i + 1) / toFetch.length));
                    await sleep(300);
                }

                allProspects.sort((a, b) => b.score - a.score);
                setProgress(100);
                addStatusLine(`‚úì Complete! Found ${allProspects.length} prospects`);
                
                displayResults();
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error(error);
            } finally {
                disableButton(false);
                setTimeout(() => {
                    document.getElementById('progress').style.display = 'none';
                }, 1000);
            }
        });

        // ========================================
        // API FUNCTIONS
        // ========================================
        async function testApiKey(apiKey) {
            console.log('Testing API key via Vercel backend...');
            try {
                const resp = await fetch(BACKEND_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'search', query: 'test', apiKey })
                });
                const data = await resp.json();
                if (data.status === 'REQUEST_DENIED') {
                    return { success: false, error: data.error_message || 'API key denied. Enable Places API and billing.' };
                } else if (data.status === 'OK' || data.status === 'ZERO_RESULTS') {
                    return { success: true };
                }
                return { success: false, error: 'Unknown API error: ' + (data.status || 'no status') };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function searchPlaces(query, apiKey) {
            try {
                const resp = await fetch(BACKEND_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'search', query, apiKey })
                });
                const data = await resp.json();
                return (data.status === 'OK') ? data.results || [] : [];
            } catch (error) {
                console.error('Search error:', error);
                return [];
            }
        }

        async function getPlaceDetails(placeId, apiKey) {
            try {
                const resp = await fetch(BACKEND_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'details', placeId, apiKey })
                });
                const data = await resp.json();
                return data.result || {};
            } catch (error) {
                console.error('Details error:', error);
                return {};
            }
        }

        // ========================================
        // SCORING
        // ========================================
        function scoreOpportunity(details) {
            let score = 0;
            let reasons = [];
            let opportunity = [];

            const rating = details.rating || 5;
            const reviews = details.user_ratings_total || 0;
            const hasWebsite = !!details.website;

            // Rating score
            if (rating <= 2.5) {
                score += 35; reasons.push('Very low rating');
                opportunity.push('Reputation management');
            } else if (rating <= 3.0) {
                score += 30; reasons.push('Low rating');
                opportunity.push('Reputation management');
            } else if (rating <= 3.5) {
                score += 22; reasons.push('Below average rating');
                opportunity.push('Review strategy');
            } else if (rating <= 3.8) {
                score += 12; reasons.push('Slightly below average');
            } else if (rating <= 4.2) {
                score += 6; reasons.push('Average rating');
            }

            // Website score
            if (!hasWebsite) {
                score += 30; reasons.push('NO WEBSITE');
                opportunity.push('Website build');
            } else {
                score += 5;
                opportunity.push('Website improvement');
            }

            // Review count score
            if (reviews >= 5 && reviews <= 30) {
                score += 20; reasons.push('Small review count');
                opportunity.push('Review growth');
            } else if (reviews > 30 && reviews <= 80) {
                score += 15; reasons.push('Moderate reviews');
            } else if (reviews > 80) {
                score += 5;
            } else {
                score += 8;
            }

            // Bonus
            if (details.formatted_phone_number) score += 5;
            if (details.business_status === 'OPERATIONAL') score += 10;

            return { score, reasons: reasons.join(' | '), opportunity: opportunity.join(', ') };
        }

        // ========================================
        // EXPANDED QUERY GENERATION
        // ========================================
        function generateQueries(businessType, location) {
            const base = businessType.toLowerCase();
            const queries = [
                `${base} ${location}`,
                `${base} contractor ${location}`,
                `${base} repair ${location}`,
                `${base} service ${location}`,
                `${base} company ${location}`,
                `local ${base} ${location}`,
                `${base} near ${location}`,
                `best ${base} ${location}`,
                `affordable ${base} ${location}`,
                `${base} installation ${location}`
            ];

            const extras = {
                'hvac': [
                    `air conditioning repair ${location}`,
                    `air conditioning installation ${location}`,
                    `furnace repair ${location}`,
                    `furnace installation ${location}`,
                    `heating cooling ${location}`,
                    `ac service ${location}`,
                    `ac tune up ${location}`,
                    `heat pump repair ${location}`,
                    `ductwork ${location}`,
                    `mini split installation ${location}`
                ],
                'plumbing': [
                    `plumber ${location}`,
                    `drain cleaning ${location}`,
                    `pipe repair ${location}`,
                    `water heater repair ${location}`,
                    `water heater installation ${location}`,
                    `leak repair ${location}`,
                    `sewer repair ${location}`,
                    `toilet repair ${location}`,
                    `emergency plumber ${location}`,
                    `bathroom plumbing ${location}`
                ],
                'roofing': [
                    `roofer ${location}`,
                    `roof replacement ${location}`,
                    `roof repair ${location}`,
                    `shingle replacement ${location}`,
                    `flat roof repair ${location}`,
                    `roof inspection ${location}`,
                    `gutter installation ${location}`,
                    `storm damage roof ${location}`,
                    `metal roofing ${location}`,
                    `roof leak repair ${location}`
                ],
                'electrical': [
                    `electrician ${location}`,
                    `electrical repair ${location}`,
                    `wiring ${location}`,
                    `panel upgrade ${location}`,
                    `outlet installation ${location}`,
                    `ceiling fan installation ${location}`,
                    `generator installation ${location}`,
                    `EV charger installation ${location}`,
                    `lighting installation ${location}`,
                    `emergency electrician ${location}`
                ],
                'landscaping': [
                    `lawn care ${location}`,
                    `lawn service ${location}`,
                    `yard maintenance ${location}`,
                    `lawn mowing ${location}`,
                    `tree trimming ${location}`,
                    `tree removal ${location}`,
                    `mulching ${location}`,
                    `sprinkler installation ${location}`,
                    `sod installation ${location}`,
                    `landscape design ${location}`
                ],
                'pest control': [
                    `exterminator ${location}`,
                    `pest exterminator ${location}`,
                    `bug exterminator ${location}`,
                    `termite treatment ${location}`,
                    `rodent control ${location}`,
                    `mosquito control ${location}`,
                    `bed bug treatment ${location}`,
                    `ant exterminator ${location}`,
                    `wildlife removal ${location}`,
                    `pest inspection ${location}`
                ],
                'cleaning': [
                    `house cleaning ${location}`,
                    `home cleaning ${location}`,
                    `maid service ${location}`,
                    `deep cleaning ${location}`,
                    `move out cleaning ${location}`,
                    `move in cleaning ${location}`,
                    `college move out cleaning ${location}`,
                    `apartment cleaning ${location}`,
                    `office cleaning ${location}`,
                    `post construction cleaning ${location}`,
                    `airbnb cleaning ${location}`,
                    `end of lease cleaning ${location}`,
                    `recurring cleaning ${location}`,
                    `residential cleaning ${location}`
                ],
                'handyman': [
                    `handyman ${location}`,
                    `home repair ${location}`,
                    `home improvement ${location}`,
                    `drywall repair ${location}`,
                    `door repair ${location}`,
                    `furniture assembly ${location}`,
                    `tv mounting ${location}`,
                    `painting ${location}`,
                    `deck repair ${location}`,
                    `fence repair ${location}`
                ]
            };

            const key = Object.keys(extras).find(k => base.includes(k));
            if (key) queries.push(...extras[key]);

            return queries;
        }

        // ========================================
        // DISPLAY RESULTS
        // ========================================
        function displayResults() {
            const hot = allProspects.filter(p => p.score >= 70).length;
            const warm = allProspects.filter(p => p.score >= 50 && p.score < 70).length;
            const noWebsite = allProspects.filter(p => !p.website).length;
            const hasWebsite = allProspects.filter(p => !!p.website).length;

            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${allProspects.length}</div>
                    <div class="stat-label">Total Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${hot}</div>
                    <div class="stat-label">Hot Leads</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${warm}</div>
                    <div class="stat-label">Warm Leads</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${noWebsite}</div>
                    <div class="stat-label">No Website</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${hasWebsite}</div>
                    <div class="stat-label">Has Website</div>
                </div>
            `;

            renderTable();
            document.getElementById('results').style.display = 'block';
        }

        function renderTable() {
            let filtered = [...allProspects];

            if (currentView === 'no-website') filtered = filtered.filter(p => !p.website);
            if (currentView === 'has-website') filtered = filtered.filter(p => !!p.website);
            if (currentView === 'hot') filtered = filtered.filter(p => p.score >= 70);

            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color: var(--text-dim); padding: 40px;">No results in this category</td></tr>`;
                return;
            }

            filtered.forEach(p => {
                const scoreClass = p.score >= 70 ? 'hot' : p.score >= 50 ? 'warm' : 'cold';
                const websiteBadge = p.website 
                    ? `<a href="${p.website}" target="_blank" class="website-link"><span class="badge has-website">View Site</span></a>`
                    : '<span class="badge no-website">NO WEBSITE</span>';

                tbody.innerHTML += `
                    <tr>
                        <td><span class="score ${scoreClass}">${p.score}</span></td>
                        <td>
                            <strong>${p.name}</strong><br>
                            <small style="color: var(--text-dim)">${p.reasons}</small><br>
                            <small style="color: var(--accent2)">üí° ${p.opportunity || 'General opportunity'}</small>
                        </td>
                        <td>${p.phone}</td>
                        <td>${p.rating} ‚≠ê</td>
                        <td>${p.reviews}</td>
                        <td>${websiteBadge}</td>
                        <td><small>${p.address}</small></td>
                    </tr>
                `;
            });
        }

        // ========================================
        // EXPORT
        // ========================================
        document.getElementById('downloadCsv').addEventListener('click', () => {
            downloadFile(convertToCSV(allProspects), 'prospects.csv', 'text/csv');
        });

        document.getElementById('copyAll').addEventListener('click', () => {
            navigator.clipboard.writeText(convertToCSV(allProspects));
            alert('Copied to clipboard!');
        });

        function convertToCSV(data) {
            const headers = ['Score', 'Business Name', 'Phone', 'Rating', 'Reviews', 'Has Website', 'Website URL', 'Address', 'Google Maps URL', 'Opportunities', 'Why Opportunity'];
            const rows = data.map(p => [
                p.score, p.name, p.phone, p.rating, p.reviews,
                p.website ? 'YES' : 'NO',
                p.website || '',
                p.address, p.mapsUrl, p.opportunity, p.reasons
            ]);
            return [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========================================
        // UI HELPERS
        // ========================================
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="status-line">${message}</div>`;
            status.className = type;
            status.style.display = 'block';
        }

        function addStatusLine(message) {
            const status = document.getElementById('status');
            const line = document.createElement('div');
            line.className = 'status-line';
            line.textContent = message;
            status.appendChild(line);
            status.scrollTop = status.scrollHeight;
        }

        function setProgress(percent) {
            document.getElementById('progress-bar').style.width = percent + '%';
        }

        function disableButton(disabled) {
            const btn = document.getElementById('runScraper');
            btn.disabled = disabled;
            btn.innerHTML = disabled ? 'Running Search...<span class="loading"></span>' : 'Run Search';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
